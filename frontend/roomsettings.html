<div class="card" id="privateRoomSettings"
     style="margin-top:10px;padding:10px;background:#f8f8f8;border-radius:10px;">
  <h3>ğŸ”’ PrivÃ©room Instellingen</h3>

  <label><input type="checkbox" id="isPrivateToggle"> Maak deze room privÃ©</label>

  <div id="privateOptions" style="display:none;margin-top:10px;">
    <label>Toegangsmodus:</label>
    <select id="privateMode">
      <option value="invite">Invite-code</option>
      <option value="password">Wachtwoord</option>
      <option value="token">Tokens</option>
    </select>

    <div id="privateKeyField" style="margin-top:8px;">
      <label>Invite-code / wachtwoord:</label>
      <input id="privateKey" type="text" placeholder="geheim123">
    </div>

    <div id="privateTokenField" style="margin-top:8px;display:none;">
      <label>Prijs in tokens:</label>
      <input id="privateTokens" type="number" min="0" value="10">
    </div>

    <button id="updatePrivateBtn"
            style="margin-top:10px;padding:8px 12px;border:0;border-radius:8px;
                   background:#1677ff;color:#fff;font-weight:600;">
      Opslaan
    </button>
  </div>
</div>

<hr style="margin:15px 0;">

<button id="resetPublicBtn"
        style="background:#ff4d4f;color:white;border:0;border-radius:8px;
               padding:8px 12px;font-weight:600;cursor:pointer;">
  ğŸ”“ Terug naar publieke room
</button>
<label>Geslacht:</label>
<select id="genderSelect">
  <option value="anon">Niet opgegeven</option>
  <option value="male">Man</option>
  <option value="female">Vrouw</option>
  <option value="trans">Transgender</option>
</select>
<button onclick="updateGender()">Opslaan</button>

<script>
async function updateGender(){
  const gender = document.getElementById("genderSelect").value;
  const token = localStorage.getItem("token");
  const res = await fetch("https://api.johka.be/api/user/update-gender", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ gender })
  });
  const data = await res.json();
  if (res.ok) alert("âœ… Geslacht aangepast naar " + data.gender);
  else alert("âŒ Fout: " + data.detail);
}
</script>

<script>
(() => {
  const API_BASE = "https://api.johka.be/api";
  const $ = (s) => document.querySelector(s);

  const toggle = $('#isPrivateToggle');
  const options = $('#privateOptions');
  const modeSel = $('#privateMode');
  const keyField = $('#privateKeyField');
  const tokenField = $('#privateTokenField');
  const updateBtn = $('#updatePrivateBtn');
  const resetBtn = $('#resetPublicBtn');

  let cachedRoomSlug = null;

  async function fetchOwnRoomSlug(token) {
    if (cachedRoomSlug) return cachedRoomSlug;
    const res = await fetch(`${API_BASE}/me`, { headers: { Authorization: "Bearer " + token } });
    if (!res.ok) throw new Error("Kon je roomgegevens niet ophalen.");
    const data = await res.json();
    cachedRoomSlug = data?.room_slug || null;
    return cachedRoomSlug;
  }

  // toggle menu tonen
  toggle.addEventListener('change', () => {
    options.style.display = toggle.checked ? 'block' : 'none';
  });

  // wissel velden
  modeSel.addEventListener('change', () => {
    const m = modeSel.value;
    keyField.style.display = (m === 'invite' || m === 'password') ? 'block' : 'none';
    tokenField.style.display = (m === 'token') ? 'block' : 'none';
  });

  // ğŸ”’ PrivÃ©room bijwerken
  updateBtn.addEventListener('click', async () => {
    const token = localStorage.getItem('token');
    if (!token) return alert("Je bent niet ingelogd.");

    const slug = await fetchOwnRoomSlug(token);
    if (!slug) return alert("Geen room gevonden.");

    if (!confirm("Weet je zeker dat je deze instellingen wilt toepassen?")) return;

    const mode = modeSel.value;
    const key = $('#privateKey')?.value || null;
    const tokens = Number($('#privateTokens')?.value || 0);

    try {
      const res = await fetch(`${API_BASE}/room/update-access`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          slug,
          access_mode: mode,
          access_key: key,
          token_price: tokens
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || data.message || res.statusText);
      alert("âœ… PrivÃ©room-instellingen bijgewerkt!");
    } catch (err) {
      console.error(err);
      alert("âŒ Fout bij opslaan: " + err.message);
    }
  });

  // ğŸ”“ Terug naar publieke room
  resetBtn.addEventListener('click', async () => {
    const token = localStorage.getItem('token');
    if (!token) return alert("Je bent niet ingelogd.");

    const slug = await fetchOwnRoomSlug(token);
    if (!slug) return alert("Geen room gekoppeld aan je account.");

    if (!confirm(`Weet je zeker dat je de room '${slug}' weer publiek wilt maken?`)) return;

    try {
      const res = await fetch(`${API_BASE}/room/update-access`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          slug,
          access_mode: "public",
          access_key: null,
          token_price: 0
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || data.message || res.statusText);

      alert("âœ… Room is nu publiek!");
      toggle.checked = false;
      options.style.display = "none";
    } catch (err) {
      console.error(err);
      alert("âŒ Mislukt: " + err.message);
    }
  });
})();
</script>
