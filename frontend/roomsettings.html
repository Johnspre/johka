<div class="card" id="privateRoomSettings" style="margin-top:10px;padding:10px;background:#f8f8f8;border-radius:10px;">
  <h3>üîí Priv√©room Instellingen</h3>

  <label><input type="checkbox" id="isPrivateToggle"> Maak deze room priv√©</label>

  <div id="privateOptions" style="display:none;margin-top:10px;">
    <label>Toegangsmodus:</label>
    <select id="privateMode">
      <option value="invite">Invite-code</option>
      <option value="password">Wachtwoord</option>
      <option value="token">Tokens</option>
    </select>

    <div id="privateKeyField" style="margin-top:8px;">
      <label>Invite-code / wachtwoord:</label>
      <input id="privateKey" type="text" placeholder="geheim123">
    </div>

    <div id="privateTokenField" style="margin-top:8px;display:none;">
      <label>Prijs in tokens:</label>
      <input id="privateTokens" type="number" min="0" value="10">
    </div>

    <button id="createPrivateBtn" style="margin-top:10px;">Priv√©room aanmaken</button>
  </div>
</div>
<hr style="margin:15px 0;">

<button id="resetPublicBtn"
  style="background:#ff4d4f;color:white;border:0;border-radius:8px;
         padding:8px 12px;font-weight:600;cursor:pointer;">
  üîì Terug naar publieke room
</button>

<script>
(() => {
  const API_BASE = "https://api.johka.be/api";
  window.__JOHKA_API_BASE = API_BASE;

  const btn = document.getElementById("resetPublicBtn");
  if (!btn) return;

  let cachedRoomSlug = null;

  async function fetchOwnRoomSlug(token) {
    if (cachedRoomSlug) return cachedRoomSlug;

    const res = await fetch(`${API_BASE}/me`, {
      headers: { Authorization: "Bearer " + token }
    });

    if (res.status === 401) {
      localStorage.removeItem("token");
      throw new Error("Je sessie is verlopen. Log opnieuw in.");
    }

    if (!res.ok) {
      throw new Error("Kon je roomgegevens niet ophalen.");
    }

    const data = await res.json();
    cachedRoomSlug = data?.room_slug || null;
    return cachedRoomSlug;
  }

  btn.addEventListener("click", async () => {
    const token = localStorage.getItem("token");
    if (!token) return alert("Je bent niet ingelogd.");

    let slug = null;
    try {
      slug = await fetchOwnRoomSlug(token);
    } catch (err) {
      console.error(err);
      alert("‚ùå Mislukt: " + err.message);
      return;
    }

    if (!slug) {
      alert("‚ùå Geen room gekoppeld aan je account.");
      return;
    }

    if (!confirm(`Weet je zeker dat je de room '${slug}' weer publiek wilt maken?`)) return;

    try {
      const res = await fetch(`${API_BASE}/room/update-access`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          slug,
          access_mode: "public",
          access_key: null,
          token_price: 0,
        }),
        })
      });

      let data;
      try {
        data = await res.json();
      } catch (_) {
        data = {};
      }

      if (!res.ok) throw new Error(data.detail || data.message || res.statusText);
      alert("‚úÖ Room is nu publiek!");

      const toggle = document.getElementById("isPrivateToggle");
      const options = document.getElementById("privateOptions");
      if (toggle) toggle.checked = false;
      if (options) options.style.display = "none";
    } catch (err) {
      console.error(err);
      alert("‚ùå Mislukt: " + err.message);
    }
  });
})();
</script>

<script>
(() => {
  const API_BASE = window.__JOHKA_API_BASE || "https://api.johka.be/api";
  const $ = (s) => document.querySelector(s);
  const toggle = $('#isPrivateToggle');
  const options = $('#privateOptions');
  const modeSel = $('#privateMode');
  const keyField = $('#privateKeyField');
  const tokenField = $('#privateTokenField');
  const btn = $('#createPrivateBtn');

  if (!toggle || !options || !modeSel || !keyField || !tokenField || !btn) return; // fragment nog niet goed geladen

  // uitklappen
  toggle.addEventListener('change', () => {
    options.style.display = toggle.checked ? 'block' : 'none';
  });

  // velden wisselen op basis van modus
  modeSel.addEventListener('change', () => {
    const m = modeSel.value;
    keyField.style.display   = (m === 'invite' || m === 'password') ? 'block' : 'none';
    tokenField.style.display = (m === 'token') ? 'block' : 'none';
  });

  // aanmaken
  btn.addEventListener('click', async () => {
    const name   = prompt('Naam van priv√©room:', 'mijn-room');
    if (!name) return;

    const mode   = modeSel.value;
    const keyInput = $('#privateKey');
    const tokenInput = $('#privateTokens');
    const key    = keyInput ? keyInput.value : null;
    const tokens = Number(tokenInput ? tokenInput.value || 0 : 0);

    const token = localStorage.getItem('token');
    if (!token) return alert('Je bent niet ingelogd.');

    try {
      const r = await fetch(`${API_BASE}/room/create-private`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, access_mode: mode, access_key: key, token_price: tokens })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || r.statusText);
      alert(`‚úÖ Priv√©room aangemaakt!\nSlug: ${data.slug}\nToegang: ${data.access_mode}`);
    } catch (e) {
      console.error(e);
      alert('‚ùå Mislukt: ' + e.message);
    }
  });
})();
</script>
