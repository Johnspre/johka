<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Johka Live ‚Äì Ontdek Creators</title>
  <link rel="stylesheet" href="/css/style-index.css" />
</head>

<body>
  <!-- üîù NAVBAR -->
  <header class="topbar">
    <div class="nav-left">
      <div class="logo">Johka Live üî•</div>
      <nav>
        <a href="#">Home</a>
        <a href="#">Discover</a>
        <a href="#">Tags</a>
        <a href="#">Private Shows</a>
        <a href="#">Following</a>
        <a href="#">Merch</a>
      </nav>
    </div>

    <div class="nav-right">
      <div class="profile-menu" id="profileMenu">
        <button id="profileBtn">üë§ Gebruiker ‚ñæ</button>
        <div class="dropdown" id="profileDropdown">
          <div class="dropdown-content">
            <div class="darkmode-toggle">
              <label for="darkSwitch">üåô Dark Mode</label>
              <input type="checkbox" id="darkSwitch" />
            </div>
            <hr />
            <p><strong>Status:</strong> Basic Member</p>
            <p><strong>Tokens:</strong> <span id="tokenCount">13</span></p>
            <hr />
            <a href="/profile.html">My Profile</a>
            <a href="/collection.html">My Collection</a>
            <a href="/feedback.html">Send Feedback</a>
            <a href="/logout.html">Log Out</a>
          </div>
        </div>
      </div>
      <button id="broadcastBtn">Broadcast Yourself</button>
      <button id="signupBtn" onclick="location.href='/register.html'">
        Sign Up ‚ñ∂
      </button>
    </div>
  </header>

  <!-- üü† MAIN -->
  <main>
    <h1>Featured Creators</h1>
    <section id="streams">Laden‚Ä¶</section>
  </main>

  <!-- ‚öôÔ∏è FOOTER -->
  <footer>¬© 2025 Johka Live ‚Äî powered by LiveKit ‚ö°</footer>

  <script>
    // ===== DROPDOWN =====
    const profileBtn = document.getElementById("profileBtn");
    const dropdown = document.getElementById("profileDropdown");
    profileBtn.addEventListener("click", () => {
      dropdown.classList.toggle("show");
    });
    window.onclick = (e) => {
      if (!e.target.matches("#profileBtn")) dropdown.classList.remove("show");
    };

    // ===== DARK MODE =====
    const darkSwitch = document.getElementById("darkSwitch");
    const prefersDark = localStorage.getItem("darkMode") === "true";
    if (prefersDark) document.body.classList.add("dark");
    darkSwitch.checked = prefersDark;

    darkSwitch.addEventListener("change", () => {
      if (darkSwitch.checked) {
        document.body.classList.add("dark");
        localStorage.setItem("darkMode", "true");
      } else {
        document.body.classList.remove("dark");
        localStorage.setItem("darkMode", "false");
      }
    });

    // ===== STREAMS OPHALEN =====
    const API = "https://api.johka.be/api";
    const container = document.getElementById("streams");

    async function loadStreams() {
      try {
        const res = await fetch(`${API}/public/streams`);
        const data = await res.json();
        if (!data.length) {
          container.innerHTML =
            "<p class='no-streams'>Momenteel geen live streams‚Ä¶</p>";
          return;
        }
        container.innerHTML = data
          .map(
            (s) => `
          <div class="card" onclick="location.href='/room.html?room=${s.room}'">
            <img src="/uploads/previews/${s.snapshot || "default.gif"}" alt="${s.username}">
            <div class="info">
              <div class="name">${s.username}</div>
              <div class="viewers">üëÅ ${s.viewers || 0} kijkers</div>
            </div>
          </div>`
          )
          .join("");
      } catch (err) {
        container.innerHTML = "<p class='error'>‚ùå Fout bij laden streams</p>";
      }
    }

    // Vernieuw streams elke 60 seconden (ipv 5)
    loadStreams();
    let refreshTimer = setInterval(loadStreams, 60000);

    // Stop verversen als tabblad niet actief is
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        clearInterval(refreshTimer);
      } else {
        loadStreams();
        refreshTimer = setInterval(loadStreams, 60000);
      }
    });

    // ===== USERNAAM TONEN & TOKEN CHECK =====
    const username = localStorage.getItem("username");
    const token = localStorage.getItem("token");

    function tokenExpired(token) {
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        const now = Math.floor(Date.now() / 1000);
        return payload.exp && payload.exp < now;
      } catch (err) {
        return true;
      }
    }

    // Token verlopen? Wissen.
    if (token && tokenExpired(token)) {
      console.log("üîí Token verlopen, uitloggen...");
      localStorage.removeItem("token");
      localStorage.removeItem("username");
    }

    // Gebruiker tonen
    if (username && token && !tokenExpired(token)) {
      profileBtn.innerText = `üë§ ${username} ‚ñæ`;
    } else {
      profileBtn.innerText = "üë§ Anonymous ‚ñæ";
      document.querySelector(".dropdown-content").innerHTML = `
        <p><strong>Status:</strong> Anonymous</p>
        <p><strong>Tokens:</strong> 0</p>
        <hr>
        <a href="/login.html">(Log In)</a>
        <a href="/register.html">(Sign Up)</a>
      `;
    }
  </script>

  

</body>
</html>
