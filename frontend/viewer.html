<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Johka Live â€“ Bekijk stream</title>
 
  <link rel="stylesheet" href="/css/style-viewer.css">

</head>
<body>
  <!-- ğŸ” TOP BAR -->
<header class="topbar">
  <div class="nav-left">
    <div class="logo">Johka Live ğŸ”¥</div>
    <nav>
      <a href="/index.html">Home</a>
      <a href="#">Discover</a>
      <a href="#">Tags</a>
      <a href="#">Private Shows</a>
      <a href="#">Following</a>
      <a href="#">Merch</a>
    </nav>
  </div>

  <div class="nav-right">
    <div class="profile-menu" id="profileMenu">
      <button id="profileBtn">ğŸ‘¤ Gebruiker â–¾</button>
      <div class="dropdown" id="profileDropdown">
        <div class="dropdown-content"></div>
      </div>
    </div>

    <button id="broadcastBtn">Broadcast Yourself</button>
    <button id="signupBtn" onclick="location.href='/register.html'">
      Sign Up â–¶
    </button>
  </div>
</header>


  <main class="viewer-layout">
  <section id="viewer-left">
    <div id="player">
      <video id="remoteVideo" autoplay playsinline></video>
      <div id="playerOverlay">Verbinden â€“ wachten op videoâ€¦</div>
    </div>

  </section>

  <aside id="viewer-right">
    <div id="streamStatusBox">
      <div id="statusBadge" class="offline"><span>â—</span><span id="statusText">Offline</span></div>
      <div id="creatorName">Onbekend</div>
      <div id="viewerCount">ğŸ‘ 0 kijkers</div>
    </div>

    <div id="chatBox">
      <div id="messageLog">Verbinden met stream...</div>
    </div>

    <form id="chatForm" class="chat-input-bar">
      <input id="chatInput" type="text" placeholder="Typ een bericht..." autocomplete="off" />
      <button id="viewerEmojiBtn" type="button">ğŸ˜Š</button>
      <button id="chatSendBtn" type="submit">Verstuur</button>
      <div id="emojiPopup" class="hidden"></div>
    </form>
    <div id="chatNotice"></div>

    <!-- ğŸ’¸ DONATIEBALK -->
<div id="donationBar">
  <input
    id="donateInput"
    type="number"
    min="1"
    step="1"
    value="10"
    inputmode="numeric"
  />
  <button id="donateBtn">ğŸ’¸ Tip</button>
</div>




    <button id="leaveBtn" class="leave-btn">ğŸšª Verlaat kamer</button>
  </aside>
  <!-- Creator info / bio panel zoals Chaturbate -->
  <section id="creatorInfoBox">
    <div id="creatorTabs">
      <button class="active" data-tab="bio">Bio</button>
      <button data-tab="pics">Pics & Videos</button>
      <button data-tab="more">More Rooms Like This</button>
      <button data-tab="share">Share</button>
    </div>
    <div id="creatorContent">
      <p id="creatorBio">Ladenâ€¦</p>
    </div>
  </section>
</main>

  <footer>Johka Live â€“ powered by LiveKit âš¡</footer>
  <script type="module" src="/js/viewer.js"></script>
  <script src="/js/navbar-auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("donateBtn");
  const input = document.getElementById("donateInput");
  if (!btn || !input) return;

  if (!input.value) input.value = "10"; // standaardwaarde

  btn.addEventListener("click", async () => {
    const raw = (input.value || "").toString().trim();
    const amount = Number(raw);

    if (!Number.isFinite(amount) || amount < 1) {
      alert("Vul een geldig aantal tokens in (bv. 5).");
      input.focus();
      return;
    }

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Je moet ingelogd zijn om te tippen.");
      return;
    }

    const params = new URLSearchParams(window.location.search);
    const toUser = params.get("u"); // streamer username uit de URL
    if (!toUser) {
      alert("Geen streamer gevonden om te tippen.");
      return;
    }

    try {
      // ğŸ”¹ API-call naar backend
      const res = await fetch("https://api.johka.be/api/tip", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token,
        },
        body: JSON.stringify({ to_username: toUser, amount }),
      });

      if (res.ok) {
        // âœ… Bevestiging
        alert(`ğŸ’¸ ${amount} tokens getipt!`);

        // âœ… Toon lokaal in chat
        if (typeof logMessage === "function") {
          logMessage(`ğŸ’¸ Jij tipte ${amount} tokens aan ${toUser}!`, "tip");
        }

        // âœ… Verstuur via LiveKit naar alle kijkers en streamer
        if (
          typeof lkRoom !== "undefined" &&
          lkRoom.state === "connected" &&
          lkRoom.localParticipant
        ) {
          const payload = {
            type: "tip",
            amount,
            sender:
              lkRoom.localParticipant.identity ||
              localStorage.getItem("username") ||
              "ik",
          };

          console.log("ğŸ’¬ Verstuur tip via LiveKit:", payload);
          lkRoom.localParticipant.publishData(
            encoder.encode(JSON.stringify(payload)),
            DataPacket_Kind.RELIABLE
          );
        } else {
          console.warn("â³ Tip uitgesteld â€“ LiveKit nog niet verbonden");
        }
      } else {
        const err = await res.text().catch(() => "");
        alert("âŒ Tip mislukt: " + (err || res.status));
      }
    } catch (e) {
      alert("âŒ Netwerkfout bij tippen.");
    }
  });
});
</script>


</body>
</html>