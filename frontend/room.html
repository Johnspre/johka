<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Johka Live â€” Room</title>
  <link rel="stylesheet" href="/css/style-room.css" />
</head>

<body>
  <!-- ğŸ” NAVBAR -->
  <nav class="navbar">
    <div id="logo">Johka Live ğŸ”¥</div>
    <div id="navLinks">
      <a href="/index.html">ğŸ  Home</a>
      <button id="goLive">ğŸ¥ Go Live</button>
      <button id="toggleCam">ğŸ“¸ Cam</button>
      <button id="toggleMic">ğŸ™ï¸ Mic</button>
      <button id="privateBtn">ğŸ”’ PrivÃ©</button>
      <button id="reconnectBtn">ğŸ” Reconnect</button>
      <button id="leave">ğŸšª Leave</button>
      <button id="viewersBtn">ğŸ‘¥ Viewers</button>
    </div>
  </nav>

  <!-- ğŸ”´ STATUSBALK -->
  <div id="streamStatus">
    <div class="left">
      <div id="liveDot"></div>
      <span id="status">verbonden: nee</span>
      <span>ğŸ‘€ <span id="viewCount">0</span></span>
      <strong>Room Subject:</strong> <span id="roomSubject">My room</span>
      <button id="editRoomBtn" onclick="editRoomSubject()">Edit</button>
    </div>
    <div class="right">ğŸ’¸ <span id="tipTotalBar">0</span> tokens</div>
  </div>

  <!-- ğŸ¬ HOOFDINHOUD -->
<main>
  <!-- ğŸ“¹ CAMERA-GEDEELTE -->
  <section id="stage">

<div id="broadcastSetup">
  <div class="setup-left">

    
</p>
    <p>You must submit age verification to receive tokens.</p>

    <label>Camera</label>
    <select id="cameraSelect"></select>

    <label>Resolution</label>
    <select id="resolutionSelect">
      <option>960 x 540</option>
      <option>1280 x 720</option>
      <option>1920 x 1080</option>
    </select>

    <label>Microphone</label>
    <select id="micSelect"></select>

    <label class="mute-row">
  <input id="muteCheck" type="checkbox">
  <span>Mute</span>
</label>

    <button id="startBroadcast" class="start-btn">Start Broadcasting</button>


  </div>

  
</div>
  </section>

  <!-- ğŸ’¬ CHAT-GEDEELTE -->
  <aside id="sidebar">
    <div id="chatTabs">
      <button data-tab="chat" class="active">ğŸ’¬ Chat</button>
      <button data-tab="users">ğŸ‘¥ Users</button>
      <button data-tab="private">ğŸ”’ PrivÃ©</button>
      <button data-tab="settings">âš™ï¸ Instellingen</button>
    </div>

    <!-- Chatpaneel -->
    <div id="chatTab" class="tabContent active">
      <div id="chat"></div>
 

      <form id="chatForm" autocomplete="off">
        <button type="button" id="emojiBtn">ğŸ˜Š</button>
        <input id="chatInput" type="text" placeholder="Typ je berichtâ€¦" />
        <button>Stuur</button>
      </form>

      <div id="donationBar">
        <input id="donateInput" type="number" min="1" placeholder="10" />
        <button id="donateBtn">ğŸ’¸ Tip</button>
      </div>
    </div>

    <!-- ğŸ‘¥ USERS TAB -->
<div id="usersTab" class="tabContent">
  <ul id="userList" style="list-style:none; padding:6px 0; margin:0;"></ul>
  <p id="anonCount" style="margin-left:10px; color:#444; font-size:14px;">+0 anonymous users</p>
</div>

    <!-- PrivÃ© -->
    <div id="privateTabContent" style="padding:10px;">
  <div id="dmMessages"
       style="border:1px solid #ddd;border-radius:8px;
              padding:10px;height:250px;overflow-y:auto;background:#fff;">
    <p class="muted">ğŸ“© Berichten laden...</p>
  </div>

  <div style="margin-top:10px;display:flex;gap:5px;">
    <input id="dmTo" type="text" placeholder="Gebruikersnaam"
           style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <input id="dmMsg" type="text" placeholder="Typ je bericht..."
           style="flex:2;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <button id="dmSendBtn"
            style="padding:8px 12px;border:0;border-radius:6px;
                   background:#1677ff;color:white;font-weight:600;cursor:pointer;">
      Verstuur
    </button>
  </div>
</div>


    <!-- Instellingen -->
    <div id="settingsTab" class="tabContent">
      <p>âš™ï¸ Stream- en accountinstellingenâ€¦</p>
    </div>
  </aside>
</main>

<!-- ğŸ”½ Ondertabs (los van stage, maar visueel eronder) -->
<div id="bottomTabs">
  <button data-page="apps.html">Apps</button>
  <button data-page="games.html">Games</button>
  <button data-page="creatorpage.html">Bio</button>
  <button data-page="roomsettings.html">Settings</button>
  <button data-page="wallet.html">Token Stats</button>
  <button data-page="share.html">Share</button>
  <button data-page="memberships.html">Memberships</button>
</div>

<!-- ğŸ“„ Container voor geladen inhoud -->
<div id="bottomContent">
  <p style="color:#777; text-align:center; margin-top:20px;">
    Selecteer een tab hierboven om te starten ğŸ‘†
  </p>
</div>


  <!-- ğŸ”» FOOTER -->
  <footer>Johka Live â€” powered by LiveKit âš¡</footer>

  <!-- ğŸ”§ Tabs-logica -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll("#chatTabs button");
      const contents = document.querySelectorAll(".tabContent");
      tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          tabs.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.dataset.tab;
          contents.forEach(c => c.classList.remove("active"));
          document.getElementById(target + "Tab").classList.add("active");
        });
      });
    });

    // live-status updater
    window.updateLivekitStatus = function(isConnected) {
      const dot = document.getElementById("liveDot");
      const status = document.getElementById("status");
      if (isConnected) {
        dot.style.background = "var(--live)";
        status.textContent = "verbonden: ja";
        status.style.color = "var(--ok)";
      } else {
        dot.style.background = "var(--muted)";
        status.textContent = "verbonden: nee";
        status.style.color = "var(--muted)";
      }
    };
  </script>
  <script>
     const API_BASE =
      window.JOHKA_API_BASE_URL ||
      (window.location.origin.includes("johka.be") ? "https://api.johka.be" : "");

    function withAuth(headers = {}) {
      const token = localStorage.getItem("token");
      if (!token) return headers;
      return {
        ...headers,
        "Authorization": `Bearer ${token}`
      };
    }

    async function ensureRoomContext() {
      if (window.roomId) return window.roomId;

      const stored = localStorage.getItem("room_id");
      if (stored && stored !== "null" && stored !== "undefined") {
        const parsed = parseInt(stored, 10);
        if (!Number.isNaN(parsed)) {
          window.roomId = parsed;
          return window.roomId;
        }
        try {
          localStorage.removeItem("room_id");
        } catch {}
      }

      const token = localStorage.getItem("token");
      if (!token) return null;

      try {
        const res = await fetch(`${API_BASE}/api/livekit-token`, {
          method: "POST",
          headers: withAuth({ "Content-Type": "application/json" }),
          body: "{}"
        });

        if (!res.ok) throw new Error("Kon roomgegevens niet ophalen");
        const data = await res.json();

        if (data.room_id) {
          window.roomId = data.room_id;
          try {
            localStorage.setItem("room_id", String(data.room_id));
          } catch {}
          } else {
          try {
            localStorage.removeItem("room_id");
          } catch {}
        }

        const subject = data.room_subject || data.room_name;
        if (subject) {
          const subjectEl = document.getElementById("roomSubject");
          if (subjectEl) subjectEl.textContent = subject;
          window.roomCurrentSubject = subject;
        }

        if (data.room_name) {
          window.roomDefaultSubject = data.room_name;
        }

        if (!window.roomId) {
          try {
            const meRes = await fetch(`${API_BASE}/api/me`, {
              headers: withAuth()
            });
            if (meRes.ok) {
              const meData = await meRes.json();
              if (meData.room_id) {
                window.roomId = meData.room_id;
                try {
                  localStorage.setItem("room_id", String(meData.room_id));
                } catch {}
              }
            }
          } catch (err) {
            console.warn("Kon room_id niet ophalen via /api/me", err);
          }
        }

        if (window.roomId && !window.roomCurrentSubject) {
          try {
            const subjectRes = await fetch(`${API_BASE}/api/room/current/${window.roomId}`);
            if (subjectRes.ok) {
              const subjectData = await subjectRes.json();
              if (subjectData.subject) {
                const subjectEl = document.getElementById("roomSubject");
                if (subjectEl) subjectEl.textContent = subjectData.subject;
                window.roomCurrentSubject = subjectData.subject;
              }
            }
          } catch (err) {
            console.warn("Kon huidig onderwerp niet ophalen", err);
          }
        }

        return window.roomId || null;
      } catch (err) {
        console.warn("Kon roomcontext niet vaststellen", err);
        return null;
      }
    }
    async function editRoomSubject() {
      let roomId = window.roomId || localStorage.getItem("room_id");
      if (!roomId) {
        roomId = await ensureRoomContext();
      }
      if (!roomId) return alert("Geen actieve room gevonden.");

      const newSubj = prompt("Nieuw onderwerp:", document.getElementById("roomSubject").textContent);
      if (newSubj === null) return;

      const trimmed = newSubj.trim();
      const numericRoomId = parseInt(roomId, 10);
      const payloadRoomId = Number.isNaN(numericRoomId) ? roomId : numericRoomId;

      const token = localStorage.getItem("token");
      if (!token) {
        return alert("Je moet ingelogd zijn om het onderwerp te wijzigen.");
      }

      const res = await fetch(`${API_BASE}/api/room/set-subject`, {
        method: "POST",
        headers: withAuth({ "Content-Type": "application/json" }),
        body: JSON.stringify({ room_id: payloadRoomId, subject: trimmed })
      });

      if (!res.ok) {
        const raw = await res.text().catch(() => "");
        let message = "Fout bij aanpassen onderwerp.";
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            const detail = parsed?.detail || parsed?.message;
            if (detail) {
              message = Array.isArray(detail) ? detail.join("\n") : String(detail);
            } else {
              message = raw;
            }
          } catch {
            message = raw;
          }
        }
        return alert(message);
      }
      const data = await res.json();
      const subjectEl = document.getElementById("roomSubject");
      if (subjectEl) subjectEl.textContent = data.subject;
      window.roomCurrentSubject = data.subject;
    }

    async function stopBroadcasting() {
      const roomId = window.roomId || localStorage.getItem("room_id");
      if (roomId) {
        const token = localStorage.getItem("token");
        if (token) {
          await fetch(`${API_BASE}/api/room/reset-subject`, {
            method: "POST",
            headers: withAuth({ "Content-Type": "application/json" }),
            body: JSON.stringify({ room_id: roomId })
          });
        }
      }
      const fallbackSubject = window.roomDefaultSubject || "My room";
      const subjectEl = document.getElementById("roomSubject");
      if (subjectEl) subjectEl.textContent = fallbackSubject;
      window.roomCurrentSubject = fallbackSubject;
    }
    document.addEventListener("DOMContentLoaded", () => {
      ensureRoomContext();
    });


  </script>
  <!-- Emoticons Script -->
<script src="https://cdn.jsdelivr.net/npm/emoji-button@4.6.2/dist/index.min.js"></script>

  <!-- ğŸ“¦ LiveKit / Johka functionaliteit -->
  <script type="module" src="/js/room.js" defer></script>


<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  if (!token) return; // niet ingelogd â†’ niets doen

  try {
    const res = await fetch("https://api.johka.be/api/wallet", {
      headers: { "Authorization": "Bearer " + token }
    });

    setInterval(async () => {
  try {
    const res = await fetch("https://api.johka.be/api/wallet", {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    if (document.getElementById("tipTotalBar")) {
      document.getElementById("tipTotalBar").textContent = data.balance ?? 0;
    }
  } catch {}
}, 60000);


    if (!res.ok) throw new Error("API fout");
    const data = await res.json();

    // ğŸ’° Toon walletsaldo in statusbalk
    const tipBar = document.getElementById("tipTotalBar");
    if (tipBar) tipBar.textContent = data.balance ?? 0;
  } catch (err) {
    console.warn("Kon walletsaldo niet ophalen:", err);
  }
});

// verwijder heel script
</script>
<script>
const API = "https://api.johka.be/api";
const token = localStorage.getItem("token");

async function loadDMs(){
  const box = document.getElementById("dmMessages");
  box.innerHTML = "<p class='muted'>ğŸ“© Laden...</p>";

  try {
    const res = await fetch(`${API}/dm/inbox`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error(await res.text());
    const msgs = await res.json();
    if (!msgs.length){
      box.innerHTML = "<p class='muted'>Nog geen privÃ©berichten.</p>";
      return;
    }
    box.innerHTML = "";
    for (const m of msgs){
      const div = document.createElement("div");
      div.className = "dm-item";
      div.style.padding = "6px";
      div.style.borderBottom = "1px solid #eee";
      div.innerHTML = `<b>${m.from}</b>: ${m.message}
        <span style="font-size:12px;color:#999;">
          (${new Date(m.time).toLocaleTimeString()})
        </span>`;
      box.appendChild(div);
    }
  } catch (err){
    console.error(err);
    box.innerHTML = "<p class='muted'>âŒ Fout bij laden.</p>";
  }
}

async function sendDM(){
  const to = document.getElementById("dmTo").value.trim();
  const msg = document.getElementById("dmMsg").value.trim();
  if (!to || !msg) return alert("Vul ontvanger en bericht in.");

  try {
    const res = await fetch(`${API}/dm/send`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ to_username: to, message: msg })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || data.message || "Fout bij verzenden");
    document.getElementById("dmMsg").value = "";
    loadDMs();
  } catch (err){
    alert("âŒ " + err.message);
  }
}

document.getElementById("dmSendBtn").addEventListener("click", sendDM);
window.addEventListener("DOMContentLoaded", loadDMs);

setInterval(loadDMs, 10000);

</script>

</body>
</html>
