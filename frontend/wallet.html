<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Johka Live ‚Äì Wallet</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #ffffff;
      color: #222;
      margin: 0;
      padding: 20px;
    }
    main {
      max-width: 700px;
      margin: auto;
    }
    h2 {
      margin-top: 30px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th { background: #f7f7f7; }
    #balanceBox {
      background: #f0f8ff;
      border: 1px solid #cfe4ff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    button {
      background: #0078ff;
      border: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #005fcc; }

    /* üî∏ Modal styling */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 25px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .modal-content h2 {
      text-align: center;
      margin-bottom: 15px;
    }
    #tokenList { list-style: none; padding: 0; }
    #tokenList li {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      background: #f9f9f9;
      cursor: pointer;
      font-weight: 500;
    }
    #tokenList li:hover { background: #e0f7e9; }
  </style>

  <script>
    const API = "https://api.johka.be/api";

    // ‚úÖ Mollie terugkeer-banner
    const params = new URLSearchParams(window.location.search);
    if (params.get("success") === "1") {
      const showPaymentBanner = () => {
        const banner = document.createElement("div");
        banner.textContent = "‚úÖ Betaling geslaagd! Je wallet is bijgewerkt.";
        banner.style = `
          background:#eaffea;
          color:#1e7e34;
          border:1px solid #b8e0b8;
          border-radius:8px;
          padding:10px 16px;
          font-weight:600;
          text-align:center;
          margin-bottom:15px;
        `;
        document.body.prepend(banner);
        fetchWallet();
        fetchHistory();
        setTimeout(() => { window.history.go(-2); }, 3000);
      };
      document.readyState === "loading"
        ? window.addEventListener("DOMContentLoaded", showPaymentBanner, { once:true })
        : showPaymentBanner();
    }

    function formatReason(reason) {
      if (!reason) return "Onbekend";
      if (reason === "mollie") return "üí≥ Opwaardering";
      if (reason.startsWith("tip:sent:")) return `üéÅ Tip verstuurd naar ${reason.split(":").slice(2).join(":")}`;
      if (reason.startsWith("tip:received:")) return `üéâ Tip ontvangen van ${reason.split(":").slice(2).join(":")}`;
      return reason;
    }

    async function fetchWallet() {
      const token = localStorage.getItem("token");
      if (!token) return location.href="/login.html";
      const res = await fetch(API + "/wallet", { headers: { Authorization:"Bearer " + token }});
      const data = await res.json();
      document.getElementById("balance").textContent = data.balance ?? 0;
    }

    async function fetchHistory() {
      const token = localStorage.getItem("token");
      if (!token) return location.href="/login.html";
      const res = await fetch(API + "/wallet/history", { headers: { Authorization:"Bearer " + token }});
      const list = await res.json();
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = list?.length ? "" : `<tr><td colspan="3">Nog geen transacties</td></tr>`;
      for (const t of list) {
        const tr = document.createElement("tr");
        const sign = t.change > 0 ? "+" : "";
        tr.innerHTML = `
          <td>${new Date(t.created_at).toLocaleString()}</td>
          <td>${formatReason(t.reason)}</td>
          <td>${sign}${t.change} tokens</td>`;
        tbody.appendChild(tr);
      }
    }

    // üí≥ Nieuw tokenkeuzevenster
    const tokenPackages = [
      { tokens:100, price:10.99, bonus:"0%" },
      { tokens:200, price:20.99, bonus:"5%" },
      { tokens:400, price:39.99, bonus:"10%" },
      { tokens:550, price:49.99, bonus:"21%" },
      { tokens:750, price:62.99, bonus:"31%" },
      { tokens:1000, price:79.99, bonus:"37%" },
      { tokens:1255, price:99.99, bonus:"38%" },
      { tokens:2025, price:159.99, bonus:"39%" },
      { tokens:4050, price:319.98, bonus:"39%" },
      { tokens:6350, price:499.99, bonus:"40%" },
      { tokens:12700, price:999.98, bonus:"40%" }
    ];

    async function topup() {
      document.getElementById("tokenModal").classList.remove("hidden");
    }

    async function createPayment(tokens) {
      const token = localStorage.getItem("token");
      if (!token) return alert("Je moet ingelogd zijn.");
      const res = await fetch(`${API}/wallet/create-payment`, {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
        body: JSON.stringify({ amount: tokens, redirect_origin: window.location.origin })
      });
      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        console.error("Backend-respons:", data);
        alert("‚ùå Fout bij starten betaling");
      }

    }

    function initTokenModal() {
      const list = document.getElementById("tokenList");
      list.innerHTML = tokenPackages.map(p => 
        `<li data-tokens="${p.tokens}">${p.tokens} tokens voor ‚Ç¨${p.price.toFixed(2)} (${p.bonus} bonus)</li>`
      ).join("");
      list.addEventListener("click", e => {
        const li = e.target.closest("li");
        if (li) {
          document.getElementById("tokenModal").classList.add("hidden");
          createPayment(li.dataset.tokens);
        }
      });
      document.getElementById("closeModal").addEventListener("click", ()=> {
        document.getElementById("tokenModal").classList.add("hidden");
      });
    }

    // üöÄ Init
    function initWalletPage() {
      fetchWallet();
      fetchHistory();
      initTokenModal();
      document.getElementById("topupBtn").addEventListener("click", topup);
    }
    document.readyState==="loading"
      ? window.addEventListener("DOMContentLoaded", initWalletPage)
      : initWalletPage();
  </script>
</head>

<body>
  <main>
    <div id="balanceBox">
      Saldo: üí∞ <span id="balance">0</span> tokens <br>
      <button id="topupBtn">Opwaarderen</button>
    </div>

    <h2>üìú Transacties</h2>
    <table>
      <thead><tr><th>Datum</th><th>Reden</th><th>Bedrag</th></tr></thead>
      <tbody><tr><td colspan="3">Laden...</td></tr></tbody>
    </table>
  </main>

  <!-- ü™ô Modal -->
  <div id="tokenModal" class="modal hidden">
    <div class="modal-content">
      <h2>üí∞ Kies je tokenpakket</h2>
      <ul id="tokenList"></ul>
      <button id="closeModal" style="margin-top:10px;width:100%">‚ùå Sluiten</button>
    </div>
  </div>
</body>
</html>
